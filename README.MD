# Easy-OpenID-Demo
## C'est quoi ?
<img align="left" width="92" style="padding-right: 1em;" src="res/unknown-user.png" alt="User profile picture" />  

D√©mo minimaliste de comment r√©aliser une identification/authentification `OpenID/OAuth2.0` avec r√©cup√©ration de **la photo du profil de l'utilisateur** ainsi que tout **un tas d'autres informations utiles** (voir JSON ci-dessous), en 1 appel de m√©thode et quelques √©couteurs.

Ce projet d√©mo montre comment tr√®s simplement s'authentifier via OpenID/OAuth2.0 depuis une SPA (Single Page Application) en utilisant [MSAL](https://learn.microsoft.com/en-us/azure/active-directory/develop/v2-overview) (librairie LTS de Microsoft pour atteindre les Graph API de Azure) pour rapidement r√©cup√©rer les informations utiles du profil de l'utilisateur d'un `tenant` comme celui de l'√âtat de Fribourg.
## Comment tester ce truc et m'en faire une id√©e avant de lire toute la tartine...
Si vous avez un compte √† l'√âtat de Fribourg : [https://www.polosoft.ch/oid/](https://www.polosoft.ch/oid/)
## Pourquoi cela peut m'√™tre utile ?
Ce petit projet d√©mo contient un worker `WrkEasyOpenId` tr√®s simple √† utiliser qui s'occupe de tout au niveau `OpenID/OAuth2.0`.

Ce worker permet de tr√®s facilement r√©aliser la bonne pratique d'**identifier et authentifier l'utilisateur le plus en amont possible de la solution technique**. Il r√©alise tout le processus `OpenID/OAuth2.0` sur simple appel d'une m√©thode et r√©cup√®re la photo du profil de l'utilisateur (si souhait√©) ainsi qu'un tas d'autres informations utiles pour que l'application sache en amont d√©j√† a qui elle a √† faire et puisse prendre les d√©cisions de filtrage qui s'imposent.
 
 Pour l'utiliser, il n'y a que **3 infos √† fournir** pour configurer OpenID et **3 m√©thodes √† appeler**.
 
 Voici un exemple des informations qui sont fournies par ce worker :
```json
{
  "token": {
    "token_id": "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",
    "expiration_not_before": "07.09.2023 16:42:55",
    "expiration_not_before_in_secs": 3556
  },
  "user": {
    "id": "YYYYYYYY-YYYY-YYYY-YYYY-YYYYYYYYYYYY",
    "displayName": "Friedli Paul",
    "mail": "paul.friedli@edufr.ch",
    "userPrincipalName": "Paul.Friedli@edufr.ch",
    "preferredLanguage": "fr-ch",
    "givenName": "Paul",
    "mobilePhone": null,
    "photo": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgA..."
  },
  "company": {
    "employeeId": "ZZZZZZZZZZZZZZZZZZ",
    "jobTitle": "Ma√Ætre/sse professionnel/le",
    "companyName": "Ecole des m√©tiers de Fribourg (EMF)",
    "department": "EMF",
    "streetAddress": "Chemin du Mus√©e 2",
    "postalCode": "1700",
    "city": "Fribourg",
    "state": "FR",
    "country": "Switzerland",
    "usageLocation": "CH"
  }
}
```
## Comment √ßa marche ?
### Utilisation
Au niveau fonctionnel, `WrkEasyOpenId` n'a que 3 m√©thodes :
1) `openIdAuthenticationLogin()` pour volontairement d√©marrer un processus `OpenID/OAuth2.0` d'identification et d'authentification de l'utilisateur lorsque cela est n√©cessaire.
2) `openIdAuthenticationLogout()` pour faire l'inverse et "d√©connecter l'application" afin d'invalider les tokens pr√©c√©demment re√ßus.
3) `openIdAuthenticationRefresh()` con√ßue pour √™tre appel√©e √† chaque (re)chargement de la SPA, pour automatiquement rafra√Æchir, automatiquement reconnecter, automatiquement obtenir √† nouveau les informations li√©es au compte (c-√†-d le compte qui avait √©t√© utilis√© avec succ√®s dans le cadre d'un appel pr√©alable √† la m√©thode `openIdAuthenticationLogin`).
### Configuration
Au niveau de sa configuration, il n'y a que 3 information n√©cessaires √† reporter dans l'ent√™te de `WrkEasyOpenId.js` (voir sa variable `msalConfig`). Reportez-y ces 3 informations re√ßues par les gestionnaires de votre domaine (*) :
1) l'url de redirection
2) l'id unique de votre application
3) l'url pour atteindre le `tenant` de votre domaine.

(*) ils devront vous cr√©er une configuration Azure de type `Single-page application` avec les droits `Access tokens (used for implicit flows)`, et lui accorder les droits `User.Read`. Rien de plus n'est n√©cessaire pour fonctionner et obtenir les informations affich√©es ici.
### Optimisation de performance pour la photo de profil
L'obtention de la photo du profil est optionnelle. Le souhait de l'obtenir doit √™tre explicitement exprim√© sans quoi elle ne sera pas retourn√©e (voir premier param√®tre bool√©en lors de l'appel √† `WrkEasyOpenId.openIdAuthenticationRefresh()` qui permet d'exprimer ce souhait).

Au niveau OpenID/OAuth2.0, la r√©cup√©ration de la photo du profil implique n√©cessairement un second appel `https` au Graph API de Azure (le premier appel √©tant pour obtenir toutes les autres informations ci-dessus d'un coup, comme l'adresse email de l'utilisateur, son employeur, ...).

Puisque la photo de profil d'un utilisateur ne change pas toutes les cinq minutes, un cache local (sessionStorage) est utilis√© pour y d√©poser la photo de profil associ√©e au `token_id`. La photo y restera disponible et valable tant que le `token_id` le sera aussi.

En cons√©quence, la photo de profil ne sera t√©l√©charg√©e qu'une fois par dur√©e de vie du `token_id`. Donc, √† moins que l'utilisateur ne se d√©logue volontairement puis se relogue, ou qu'il attende derri√®re son √©cran suffisamment longtemps pour que le `token_id` de la session finisse par devenir invalide, √† chaque refresh la photo de profil sera reprise du cache local ce qui sera instantan√©. Et du coup, l'ensemble du processus de rafra√Æchissement en sera tr√®s grandement acc√©l√©r√©.

## Que contient ce projet de d√©monstration ?
Ce projet contient les fichiers suivants :
| Fichier    | Mission, signification, contenu (c'est bon vous m'avez compris hihi) |
| -------- | ------- |
| [index.html](index.html)  | HTML minimaliste de cette SPA fournissant un bouton **Login** et **Logout** ainsi qu'une zone o√π seront montr√©es toutes les informations re√ßues dans le **&lt;DIV&gt;** avec l'`id="all-profile-infos-will-be-then-displayed-here"`|
| [oid.css](css/oid.css) | pour que la page HTML ne soit pas trop moche √† regarder. |
| [IhmUtils.js](js/ihm/IhmUtils.js) |une seule m√©thode responsable de transformer le JSON re√ßu (avec toutes les informations du profil utilisateur et photo de profil) en HTML a afficher. Cet HTML est inject√© par le Ctrl dans le **&lt;DIV&gt;** ci-dessus avec l'`id="all-profile-infos-will-be-then-displayed-here"`.|
| [WrkEasyOpenId.js](js/openid/WrkEasyOpenId.js) | qui contient mon worker qui devrait s'occuper de tout au niveau OpenID/OAuth2.0, login, logout et redirection. |
| [Ctrl.js](js/ctrl/Ctrl.js) | le contr√¥leur de l'application qui appelle `openIdAuthenticationRefresh()` au chargement de la page et qui ne contient que 6 √©couteurs : 2 pour √©couter les boutons de l'ihm pour appeler les m√©thodes login() et logout de `WrkEasyOpenId` lorsque press√©s, et 4 pour √™tre notifi√©s par `WrkEasyOpenId` des √©v√©nements tels que authentification r√©ussie, √©chou√©e, en cours, ... |
## Copyright ¬©
<img align="left" width="128" style="padding-right: 1em;" src="res/WTFPL_logo.svg.png" alt="WTFPL image" />  

Comme indiqu√© dans `WrkEasyOpenId.js`, ce logiciel est publi√© sous le mod√®le de licence [WTFPL](https://fr.wikipedia.org/wiki/WTFPL).
**WTFPL** = _Do What The Fuck You Want Public License_.  

Donc _NO rights reserved_, _NO copyrights_ et ... _NO responsabilities_ üòÅ

Seulement :
1) une bi√®re üòé au d√©veloppeur si vous trouvez `WrkEasyOpenId.js` utile et que vous l'utilisez
2) y conserver l'ent√™te avec mention de l'auteur
